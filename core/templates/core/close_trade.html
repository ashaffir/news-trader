{% extends 'core/base.html' %}

{% block title %}Open Trades - News Trader{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced Styling for Unified Close Trade Page */
    body {
        padding-top: 20px;
        background-color: #f8f9fa;
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
    }

    .symbol-badge {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .direction-long {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .direction-short {
        background: linear-gradient(45deg, #dc3545, #c82333);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .profit-positive {
        color: #28a745;
        font-weight: bold;
    }

    .profit-negative {
        color: #dc3545;
        font-weight: bold;
    }

    .profit-neutral {
        color: #6c757d;
        font-weight: bold;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .status-open {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
    }

    .status-pending-close {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        color: white;
    }

    .status-closed {
        background: linear-gradient(45deg, #6c757d, #495057);
        color: white;
    }

    .close-btn {
        background: linear-gradient(45deg, #dc3545, #c82333);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .close-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        color: white;
    }

    .edit-btn {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .edit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        color: white;
    }

    .close-all-btn {
        background: linear-gradient(45deg, #dc3545, #c82333);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 10px 20px;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
    }

    .close-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        color: white;
    }

    .actions-column {
        min-width: 160px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .tp-sl-info {
        font-size: 0.75rem;
        line-height: 1.2;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-times-circle me-2"></i>Open Trades
                </h1>
                <div>
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            
            {% if open_trades %}
                <!-- Close All Positions Button -->
                {% if open_trades|length > 1 %}
                <div class="mb-4">
                    <button type="button" class="close-all-btn" data-bs-toggle="modal" data-bs-target="#closeAllModal">
                        <i class="fas fa-times-circle"></i>
                        Close All Positions ({{ open_trades|length }})
                    </button>
                </div>
                {% endif %}

                <!-- Open Trades Table -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                        <h5 class="mb-0">
                            <i class="fas fa-coins me-2"></i>Active Positions
                            <span class="badge bg-light text-dark ms-2">{{ open_trades|length }}</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-tag me-1"></i>Symbol</th>
                                        <th><i class="fas fa-exchange-alt me-1"></i>Direction</th>
                                        <th><i class="fas fa-coins me-1"></i>Quantity</th>
                                        <th><i class="fas fa-dollar-sign me-1"></i>Entry Price</th>
                                        <th><i class="fas fa-bullseye me-1"></i>TP/SL</th>
                                        <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                        <th><i class="fas fa-chart-area me-1"></i>P&L</th>
                                        <th><i class="fas fa-percentage me-1"></i>P&L</th>
                                        <th class="actions-column"><i class="fas fa-cogs me-1"></i>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trade in open_trades %}
                                    <tr>
                                        <td>
                                            <span class="symbol-badge">{{ trade.symbol }}</span>
                                        </td>
                                        <td>
                                            <span class="{% if trade.direction == 'buy' %}direction-long{% else %}direction-short{% endif %}">
                                                {% if trade.direction == 'buy' %}
                                                <i class="fas fa-arrow-up me-1"></i>LONG
                                                {% else %}
                                                <i class="fas fa-arrow-down me-1"></i>SHORT
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td><strong>{{ trade.quantity|floatformat:0 }}</strong></td>
                                        <td><strong>${{ trade.entry_price|floatformat:2 }}</strong></td>
                                        <td>
                                            <div class="d-flex flex-column gap-1">
                                                {% if trade.take_profit_price or trade.take_profit_price_percentage %}
                                                <div class="tp-sl-info">
                                                    <small class="text-success fw-bold">
                                                        <i class="fas fa-bullseye me-1"></i>TP: 
                                                        {% if trade.take_profit_price_percentage %}
                                                            {{ trade.take_profit_price_percentage|floatformat:1 }}%
                                                        {% endif %}
                                                        {% if trade.take_profit_price %}
                                                            (${{ trade.take_profit_price|floatformat:2 }})
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                {% endif %}
                                                {% if trade.stop_loss_price or trade.stop_loss_price_percentage %}
                                                <div class="tp-sl-info">
                                                    <small class="text-danger fw-bold">
                                                        <i class="fas fa-shield-alt me-1"></i>SL: 
                                                        {% if trade.stop_loss_price_percentage %}
                                                            {{ trade.stop_loss_price_percentage|floatformat:1 }}%
                                                        {% endif %}
                                                        {% if trade.stop_loss_price %}
                                                            (${{ trade.stop_loss_price|floatformat:2 }})
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                {% endif %}
                                                {% if not trade.take_profit_price and not trade.take_profit_price_percentage and not trade.stop_loss_price and not trade.stop_loss_price_percentage %}
                                                <small class="text-muted">
                                                    <i class="fas fa-minus me-1"></i>Not Set
                                                </small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge status-{{ trade.status|slugify }}">{{ trade.status|capfirst }}</span>
                                        </td>
                                        <td>
                                            {% if trade.alpaca_position %}
                                                {% if trade.unrealized_pnl > 0 %}
                                                <span class="profit-positive">
                                                    <i class="fas fa-arrow-up me-1"></i>+${{ trade.unrealized_pnl|floatformat:2 }}
                                                </span>
                                                {% elif trade.unrealized_pnl < 0 %}
                                                <span class="profit-negative">
                                                    <i class="fas fa-arrow-down me-1"></i>${{ trade.unrealized_pnl|floatformat:2 }}
                                                </span>
                                                {% else %}
                                                <span class="profit-neutral">
                                                    <i class="fas fa-minus me-1"></i>$0.00
                                                </span>
                                                {% endif %}
                                            {% else %}
                                            <span class="profit-neutral">
                                                <i class="fas fa-minus me-1"></i>$0.00
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if trade.alpaca_position and trade.entry_price > 0 and trade.quantity > 0 %}
                                                {% if trade.pnl_percentage > 0 %}
                                                <span class="profit-positive">
                                                    <i class="fas fa-arrow-up me-1"></i>+{{ trade.pnl_percentage|floatformat:1 }}%
                                                </span>
                                                {% elif trade.pnl_percentage < 0 %}
                                                <span class="profit-negative">
                                                    <i class="fas fa-arrow-down me-1"></i>{{ trade.pnl_percentage|floatformat:1 }}%
                                                </span>
                                                {% else %}
                                                <span class="profit-neutral">
                                                    <i class="fas fa-minus me-1"></i>0.0%
                                                </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="profit-neutral">
                                                    <i class="fas fa-minus me-1"></i>0.0%
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button type="button" class="edit-btn" data-bs-toggle="modal"
                                                    data-bs-target="#editTradeModal" data-trade-id="{{ trade.id }}"
                                                    data-symbol="{{ trade.symbol }}" data-entry-price="{{ trade.entry_price }}"
                                                    data-current-pnl="{{ trade.unrealized_pnl|default:0 }}"
                                                    data-quantity="{{ trade.quantity }}"
                                                    data-tp-percent="{{ trade.take_profit_price_percentage|default:'' }}"
                                                    data-sl-percent="{{ trade.stop_loss_price_percentage|default:'' }}">
                                                    <i class="fas fa-pencil-alt"></i>Edit
                                                </button>
                                                <button type="button" class="close-btn" data-bs-toggle="modal"
                                                    data-bs-target="#closeTradeModal" data-trade-id="{{ trade.id }}"
                                                    data-symbol="{{ trade.symbol }}" data-quantity="{{ trade.quantity }}"
                                                    data-pnl="{{ trade.unrealized_pnl|default:0 }}"
                                                    data-entry-price="{{ trade.entry_price }}">
                                                    <i class="fas fa-times"></i>Close
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Open Trades</h5>
                    <p class="text-muted">All positions have been closed or no trades have been executed yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Close Trade Confirmation Modal -->
<div class="modal fade" id="closeTradeModal" tabindex="-1" aria-labelledby="closeTradeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="closeTradeModalLabel">
                    <i class="fas fa-times-circle me-2"></i>Close Trade Confirmation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> You are about to close this position. This action cannot be undone.
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Symbol:</strong><br>
                        <span id="close-symbol" class="badge bg-primary">-</span>
                    </div>
                    <div class="col-6">
                        <strong>Quantity:</strong><br>
                        <span id="close-quantity">-</span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Entry Price:</strong><br>
                        $<span id="close-entry-price">-</span>
                    </div>
                    <div class="col-6">
                        <strong>Current P&L:</strong><br>
                        <span id="close-pnl" class="fw-bold">-</span>
                    </div>
                </div>

                <form method="post" style="display: inline;" id="closeTradeForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="close_trade">
                    <input type="hidden" name="trade_id" value="" id="close-trade-id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-cancel-btn">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" form="closeTradeForm" class="btn btn-danger" id="close-confirm-btn">
                    <span id="close-btn-text">
                        <i class="fas fa-times me-1"></i>Close Position
                    </span>
                    <span class="d-none" id="close-btn-spinner">
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        Closing...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Trade Modal -->
<div class="modal fade" id="editTradeModal" tabindex="-1" aria-labelledby="editTradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTradeModalLabel">
                    <i class="fas fa-pencil-alt me-2"></i>Edit Trade Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="editTradeForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_trade">
                    <input type="hidden" name="trade_id" id="edit-trade-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="take_profit_percent" class="form-label">Take Profit (%)</label>
                            <input type="number" class="form-control" name="take_profit_percent"
                                id="take_profit_percent" step="0.1" min="0" max="100" placeholder="e.g., 5.0">
                        </div>
                        <div class="col-md-6">
                            <label for="stop_loss_percent" class="form-label">Stop Loss (%)</label>
                            <input type="number" class="form-control" name="stop_loss_percent" id="stop_loss_percent"
                                step="0.1" min="0" max="100" placeholder="e.g., 2.0">
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Current P&L:</strong> <span id="edit-current-pnl">-</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editTradeForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Close All Positions Modal -->
{% if open_trades|length > 1 %}
<div class="modal fade" id="closeAllModal" tabindex="-1" aria-labelledby="closeAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="closeAllModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Close All Positions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>WARNING:</strong> You are about to close ALL {{ open_trades|length }} open position{{ open_trades|length|pluralize }}. This action cannot be undone.
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmCloseAll">
                    <label class="form-check-label" for="confirmCloseAll">
                        I understand this will close all my open positions
                    </label>
                </div>

                <form method="post" id="closeAllForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="close_all_trades">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-all-cancel-btn">
                    Cancel
                </button>
                <button type="submit" form="closeAllForm" class="btn btn-danger" id="confirmCloseAllBtn" disabled>
                    <span id="close-all-btn-text">
                        <i class="fas fa-times-circle me-1"></i>Close All Positions
                    </span>
                    <span class="d-none" id="close-all-btn-spinner">
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        Closing All...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- JavaScript moved to main content block for immediate loading -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Close trade modal
        const closeTradeModal = document.getElementById('closeTradeModal');
        closeTradeModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const tradeId = button.getAttribute('data-trade-id');
            const symbol = button.getAttribute('data-symbol');
            const quantity = button.getAttribute('data-quantity');
            const entryPrice = parseFloat(button.getAttribute('data-entry-price')) || 0;
            const pnl = parseFloat(button.getAttribute('data-pnl')) || 0;

            // Populate modal fields
            document.getElementById('close-symbol').textContent = symbol;
            document.getElementById('close-quantity').textContent = quantity;
            document.getElementById('close-entry-price').textContent = entryPrice.toFixed(2);
            document.getElementById('close-trade-id').value = tradeId;

            const pnlElement = document.getElementById('close-pnl');
            let pnlText = '';
            let pnlPercentage = '';
            
            if (entryPrice > 0 && quantityNum > 0) {
                const costBasis = entryPrice * quantityNum;
                const percentage = (pnl / costBasis) * 100;
                pnlPercentage = ' (' + (pnl >= 0 ? '+' : '') + percentage.toFixed(1) + '%)';
            }
            
            if (pnl > 0) {
                pnlText = '+$' + pnl.toFixed(2) + pnlPercentage;
                pnlElement.className = 'fw-bold text-success';
            } else if (pnl < 0) {
                pnlText = '$' + pnl.toFixed(2) + pnlPercentage;
                pnlElement.className = 'fw-bold text-danger';
            } else {
                pnlText = '$0.00 (0.0%)';
                pnlElement.className = 'fw-bold text-muted';
            }
            
            pnlElement.textContent = pnlText;
        });

        // Handle close trade form submission
        const closeTradeForm = document.getElementById('closeTradeForm');
        closeTradeForm.addEventListener('submit', function(event) {
            const confirmBtn = document.getElementById('close-confirm-btn');
            const cancelBtn = document.getElementById('close-cancel-btn');
            const btnText = document.getElementById('close-btn-text');
            const btnSpinner = document.getElementById('close-btn-spinner');
            
            // Show spinner and disable buttons
            btnText.classList.add('d-none');
            btnSpinner.classList.remove('d-none');
            confirmBtn.disabled = true;
            cancelBtn.disabled = true;
        });

        // Edit trade modal
        const editTradeModal = document.getElementById('editTradeModal');
        editTradeModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const tradeId = button.getAttribute('data-trade-id');
            const pnl = parseFloat(button.getAttribute('data-current-pnl')) || 0;
            const tpPercent = button.getAttribute('data-tp-percent');
            const slPercent = button.getAttribute('data-sl-percent');

            // Set trade ID and current P&L
            document.getElementById('edit-trade-id').value = tradeId;
            document.getElementById('edit-current-pnl').textContent = '$' + pnl.toFixed(2);
            
            // Populate existing TP/SL percentages if they exist
            const tpInput = document.getElementById('take_profit_percent');
            const slInput = document.getElementById('stop_loss_percent');
            
            if (tpPercent && tpPercent !== 'None') {
                tpInput.value = parseFloat(tpPercent).toFixed(1);
            } else {
                tpInput.value = '';
            }
            
            if (slPercent && slPercent !== 'None') {
                slInput.value = parseFloat(slPercent).toFixed(1);
            } else {
                slInput.value = '';
            }
        });

        // Handle edit form submission
        const editTradeForm = document.getElementById('editTradeForm');
        if (editTradeForm) {
            editTradeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);
                
                // Show loading state
                const saveBtn = document.querySelector('#editTradeModal .btn-primary');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
                saveBtn.disabled = true;
                
                console.log('Sending edit request with data:', data);
                
                fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        console.log('Success! Calling showSuccessModal...');
                        // Show success modal
                        showSuccessModal(data.message, data.take_profit_percent, data.stop_loss_percent);
                        bootstrap.Modal.getInstance(editTradeModal).hide();
                        
                        // Reload page after a short delay to show updated values
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        console.log('Error response:', data.error);
                        showToast('Error', data.error || 'Failed to update trade settings', 'error');
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    showToast('Error', 'Network error occurred', 'error');
                })
                .finally(() => {
                    // Reset button state
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                });
            });
        }

        // Close All functionality
        const confirmCheckbox = document.getElementById('confirmCloseAll');
        const confirmButton = document.getElementById('confirmCloseAllBtn');

        if (confirmCheckbox && confirmButton) {
            confirmCheckbox.addEventListener('change', function () {
                confirmButton.disabled = !this.checked;
            });
        }

        // Handle close all form submission
        const closeAllForm = document.getElementById('closeAllForm');
        if (closeAllForm) {
            closeAllForm.addEventListener('submit', function(event) {
                const confirmBtn = document.getElementById('confirmCloseAllBtn');
                const cancelBtn = document.getElementById('close-all-cancel-btn');
                const btnText = document.getElementById('close-all-btn-text');
                const btnSpinner = document.getElementById('close-all-btn-spinner');
                
                // Show spinner and disable buttons
                btnText.classList.add('d-none');
                btnSpinner.classList.remove('d-none');
                confirmBtn.disabled = true;
                cancelBtn.disabled = true;
            });
        }
    });

    // Success modal function
    function showSuccessModal(message, tpPercent, slPercent) {
        console.log('showSuccessModal called with:', message, tpPercent, slPercent);
        // Create and show success modal
        const successModalHtml = `
            <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="successModalLabel">
                                <i class="fas fa-check-circle me-2"></i>Trade Settings Updated
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-check-circle me-2"></i>${message}
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Take Profit:</strong><br>
                                    <span class="text-success fs-5">${tpPercent ? tpPercent + '%' : 'Not Set'}</span>
                                </div>
                                <div class="col-6">
                                    <strong>Stop Loss:</strong><br>
                                    <span class="text-danger fs-5">${slPercent ? slPercent + '%' : 'Not Set'}</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    The page will refresh automatically to show updated values.
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                                <i class="fas fa-check me-1"></i>OK
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing success modal if any
        const existingModal = document.getElementById('successModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add new modal to body
        document.body.insertAdjacentHTML('beforeend', successModalHtml);
        
        // Show the modal
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            successModal.hide();
        }, 3000);
    }

    // Toast function
    function showToast(title, message, type) {
        // Create toast if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        const toastHtml = `
            <div class="toast ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    // CSRF token function
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }
</script>
{% endblock %}