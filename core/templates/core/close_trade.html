{% extends 'core/base.html' %}

{% block title %}Open Trades - News Trader{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-times-circle me-2"></i>Open Trades
                </h1>
                <div>
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            
            {% if trades %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Active Positions ({{ trades|length }})
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Symbol</th>
                                        <th>Direction</th>
                                        <th>Quantity</th>
                                        <th>Entry Price</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trade in trades %}
                                    <tr>
                                        <td class="fw-bold">#{{ trade.id }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ trade.symbol }}</span>
                                        </td>
                                        <td>
                                            {% if trade.direction == 'buy' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-arrow-up me-1"></i>BUY
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-arrow-down me-1"></i>SELL
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>{{ trade.quantity }}</td>
                                        <td>${{ trade.entry_price|floatformat:2 }}</td>
                                        <td>
                                            {% if trade.status == 'open' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-circle me-1"></i>OPEN
                                                </span>
                                            {% elif trade.status == 'pending_close' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-clock me-1"></i>CLOSING
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ trade.status|upper }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ trade.created_at|date:"M d, Y H:i" }}</small>
                                        </td>
                                                                                 <td>
                                             {% if trade.status == 'open' %}
                                                 <button class="btn btn-danger btn-sm" 
                                                         onclick="closeTrade({{ trade.id }}, '{{ trade.symbol }}')"
                                                         title="Close this position">
                                                     <i class="fas fa-times me-1"></i>Close
                                                 </button>
                                             {% elif trade.status == 'pending' %}
                                                 <button class="btn btn-warning btn-sm" 
                                                         onclick="cancelTrade({{ trade.id }}, '{{ trade.symbol }}')"
                                                         title="Cancel pending order">
                                                     <i class="fas fa-ban me-1"></i>Cancel
                                                 </button>
                                                 <button class="btn btn-info btn-sm ms-1" 
                                                         onclick="refreshTradeStatus({{ trade.id }})"
                                                         title="Check order status">
                                                     <i class="fas fa-sync me-1"></i>Refresh
                                                 </button>
                                             {% elif trade.status == 'pending_close' %}
                                                 <span class="text-warning">
                                                     <i class="fas fa-hourglass-half"></i> Closing...
                                                 </span>
                                             {% else %}
                                                 <span class="text-muted">
                                                     <i class="fas fa-check-circle"></i> {{ trade.status|title }}
                                                 </span>
                                             {% endif %}
                                         </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Showing {{ trades|length }} open position{{ trades|length|pluralize }}
                        </small>
                    </div>
                </div>
            {% else %}
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body py-5">
                                <div class="mb-4">
                                    <i class="fas fa-chart-line-down fa-4x text-muted"></i>
                                </div>
                                <h4 class="card-title">No Open Trades</h4>
                                <p class="card-text text-muted">
                                    There are currently no open positions to manage.
                                </p>
                                <div class="mt-4">
                                    <a href="/" class="btn btn-primary me-2">
                                        <i class="fas fa-tachometer-alt me-1"></i>Go to Dashboard
                                    </a>
                                    <a href="/test-page/" class="btn btn-outline-secondary">
                                        <i class="fas fa-flask me-1"></i>Test Center
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Success/Error Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Trade Status</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function closeTrade(tradeId, symbol) {
    if (confirm(`Are you sure you want to close the ${symbol} position (ID: ${tradeId})?`)) {
        // Show loading state
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Closing...';
        button.disabled = true;
        
        fetch('/api/close-trade/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                trade_id: tradeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', `Trade closure initiated for ${symbol}`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error', data.error || 'Failed to close trade', 'error');
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Network error occurred', 'error');
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

function cancelTrade(tradeId, symbol) {
    if (confirm(`Are you sure you want to cancel the pending ${symbol} order (ID: ${tradeId})?`)) {
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Canceling...';
        button.disabled = true;
        
        fetch('/api/cancel-trade/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                trade_id: tradeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', `Order cancellation initiated for ${symbol}`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error', data.error || 'Failed to cancel order', 'error');
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Network error occurred', 'error');
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

function refreshTradeStatus(tradeId) {
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    button.disabled = true;
    
    fetch(`/api/trade-status/${tradeId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', `Status updated: ${data.status}`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error || 'Failed to refresh status', 'error');
        }
        button.innerHTML = originalHTML;
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'Network error occurred', 'error');
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

function showToast(title, message, type) {
    const toast = document.getElementById('statusToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    
    // Update toast styling based on type
    toast.className = `toast ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}`;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue;
}

// Auto-refresh every 30 seconds if there are open trades
{% if trades %}
setInterval(() => {
    location.reload();
}, 30000);
{% endif %}
</script>
{% endblock %} 