{% extends 'core/base.html' %}
{% load static %}

{% block title %}News Trader Dashboard{% endblock %}

{% block extra_head %}
<link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1">News Trading Dashboard</h1>
                        <p class="text-muted mb-0">Real-time monitoring and control center</p>
                    </div>
                    <div>
                        <span id="polling-status" class="polling-status">
                            <i class="fas fa-circle me-1" style="color: #28a745;"></i>
                            Live Updates Active
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot Status Toggle -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" style="border-left: 4px solid #007bff;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    <i class="fas fa-robot me-2"></i>Trading Bot Status
                                </h5>
                                <p class="mb-0 text-muted">
                                    <span id="bot-status-text">Bot status loading...</span>
                                </p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="botToggle"
                                    style="width: 3rem; height: 1.5rem;">
                                <label class="form-check-label fw-bold ms-2" for="botToggle" id="bot-toggle-label">
                                    LOADING...
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Status Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-plug me-2 text-primary"></i>
                            API Connections
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4" id="api-status-row">
                            <!-- OpenAI -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center p-4">
                                        <div class="mb-3">
                                            <i class="fas fa-brain text-primary" style="font-size: 2.5rem;"></i>
                                        </div>
                                        <h6 class="card-title mb-2">OpenAI</h6>
                                        <div class="mb-3">
                                            <span class="badge bg-secondary status-badge">Unknown</span>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm w-100"
                                            onclick="checkConnection('openai')">
                                            <i class="fas fa-sync-alt me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- News Sources -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center p-4">
                                        <div class="mb-3">
                                            <i class="fas fa-newspaper text-info" style="font-size: 2.5rem;"></i>
                                        </div>
                                        <h6 class="card-title mb-2">News Sources</h6>
                                        <div class="mb-2">
                                            <span class="badge bg-secondary status-badge">Unknown</span>
                                        </div>
                                        <div class="small text-muted mb-3" id="news-sources-details">Loading...</div>
                                        <div class="small text-muted">
                                            <i class="fas fa-sync-alt me-1"></i>Auto-updated
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Alpaca -->
                            <div class="col-md-4">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center p-4">
                                        <div class="mb-3">
                                            <i class="fas fa-chart-line text-success" style="font-size: 2.5rem;"></i>
                                        </div>
                                        <h6 class="card-title mb-2">Alpaca Trading</h6>
                                        <div class="mb-3">
                                            <span class="badge bg-secondary status-badge">Unknown</span>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm w-100"
                                            onclick="checkConnection('alpaca')">
                                            <i class="fas fa-sync-alt me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <h6 class="mb-1">Posts (24h)</h6>
                    <h3 class="mb-0" id="posts-count">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h6 class="mb-1">Analyses (24h)</h6>
                    <h3 class="mb-0" id="analyses-count">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h6 class="mb-1">Trades (24h)</h6>
                    <h3 class="mb-0" id="trades-count">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h6 class="mb-1">Win Rate</h6>
                    <h3 class="mb-0" id="win-rate">-</h3>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Column: Status Cards -->
            <div class="col-md-8">
                <!-- Scraper Status -->
                <div class="status-card">
                    <h5 class="mb-3">
                        <i class="fas fa-spider me-2"></i>Scraper Status
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="badge bg-info fs-6 p-2">
                                    <span id="sources-active">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Active Sources</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="badge bg-success fs-6 p-2">
                                    <span id="last-scrape">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Last Scrape</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="badge bg-warning fs-6 p-2">
                                    <span id="next-scrape">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Next Scrape</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Status -->
                <div class="status-card">
                    <h5 class="mb-3">
                        <i class="fas fa-brain me-2"></i>Analysis Status
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="badge bg-primary fs-6 p-2">
                                    <span id="pending-analysis">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Pending</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="badge bg-success fs-6 p-2">
                                    <span id="avg-confidence">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Avg Confidence</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="badge bg-info fs-6 p-2">
                                    <span id="last-analysis">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Last Analysis</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Status -->
                <div class="status-card">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-line me-2"></i>Trading Status
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success fs-6 p-2">
                                    <span id="open-positions">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Open Positions</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-info fs-6 p-2">
                                    <span id="total-pnl">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Total P&L</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-warning fs-6 p-2">
                                    <span id="day-pnl">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Day P&L</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-primary fs-6 p-2">
                                    <span id="account-value">-</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Account Value</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Activity Log -->
            <div class="col-md-4">
                <div class="status-card">
                    <h5 class="mb-3">
                        <i class="fas fa-list me-2"></i>Activity Log
                    </h5>
                    <div id="log" style="max-height: 400px; overflow-y: auto;">
                        <div class="log-entry">
                            <i class="fas fa-info-circle me-2"></i>Dashboard initialized
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto-refresh indicator -->
        <div class="row mt-3">
            <div class="col-12">
                <p class="text-muted text-center">
                    <i class="fas fa-sync me-1"></i>Auto-refreshing every 30 seconds
                </p>
            </div>
        </div>
    </div>

    <!-- Connection Check Modal -->
    <div class="modal fade" id="connectionCheckModal" tabindex="-1" aria-labelledby="connectionCheckModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="connectionCheckModalLabel">
                        <i class="fas fa-link me-2"></i>Connection Check Result
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="connectionCheckResult">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Checking connection...</span>
                            </div>
                            <p class="mt-2">Checking connection...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="recheckButton" onclick="recheckConnection()">
                        <i class="fas fa-refresh me-1"></i>Check Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Status Confirmation Modal -->
    <div class="modal fade" id="botToggleConfirmModal" tabindex="-1" aria-labelledby="botToggleConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="botToggleConfirmModalLabel">
                        <i class="fas fa-robot me-2"></i>Confirm Bot Status Change
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="botToggleConfirmContent">
                        <div class="text-center mb-3">
                            <i id="botToggleConfirmIcon" class="fas fa-question-circle text-warning" style="font-size: 3rem;"></i>
                        </div>
                        <div class="alert" id="botToggleConfirmAlert">
                            <h6 id="botToggleConfirmTitle" class="mb-2"></h6>
                            <p id="botToggleConfirmMessage" class="mb-0"></p>
                        </div>
                        <div class="small text-muted mt-2">
                            <strong>Note:</strong> This will affect all bot activities including scraping, analysis, and trading.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn" id="botToggleConfirmButton" onclick="confirmBotToggle()">
                        <i class="fas fa-check me-1"></i><span id="botToggleConfirmButtonText">Confirm</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed inline dashboard JS; now loaded via static file -->
    <script>
        // Initialize variables
        const logDiv = document.getElementById('log');
        const botToggle = document.getElementById('botToggle');
        const botStatusText = document.getElementById('bot-status-text');
        const botToggleLabel = document.getElementById('bot-toggle-label');

        // Simple polling for updates - much more reliable than WebSockets!
        let lastActivityId = 0;
        
        function pollForUpdates() {
            fetch('/api/recent-activities/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.activities.length > 0) {
                        // Only show new activities
                        const newActivities = data.activities.filter(activity => activity.id > lastActivityId);
                        
                        newActivities.reverse().forEach(activity => {
                            const icon = getActivityIcon(activity.type);
                            const timestamp = new Date(activity.created_at).toLocaleTimeString();
                            addLogEntry(`${icon} ${activity.message}`, getActivityClass(activity.type), timestamp);
                            lastActivityId = Math.max(lastActivityId, activity.id);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error polling for updates:', error);
                });
        }

        function getActivityIcon(type) {
            const icons = {
                'scraper_status': '📥',
                'new_analysis': '🧠', 
                'manual_trade_success': '✅',
                'trade_error': '❌',
                'trade_rejected': '🚫',
                'trade_skipped': '⏸️',
                'scraper_error': '⚠️',
                'analysis_error': '⚠️',
                'trade_status_updated': '🔄'
            };
            return icons[type] || 'ℹ️';
        }

        function getActivityClass(type) {
            const classes = {
                'scraper_status': 'text-primary',
                'new_analysis': 'text-info',
                'manual_trade_success': 'text-success', 
                'trade_error': 'text-danger',
                'trade_rejected': 'text-danger',
                'trade_skipped': 'text-warning',
                'scraper_error': 'text-danger',
                'analysis_error': 'text-danger',
                'trade_status_updated': 'text-info'
            };
            return classes[type] || 'text-muted';
        }

        // Add log entry function
        function addLogEntry(message, className = 'text-primary') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + className;
            logEntry.innerHTML = `
                <i class="fas fa-circle me-2" style="font-size: 6px;"></i>
                <small class="text-muted">${timestamp}</small> ${message}
            `;
            logDiv.insertBefore(logEntry, logDiv.firstChild);

            // Keep only last 20 entries
            while (logDiv.children.length > 20) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // Handle structured WebSocket updates
        function handleStructuredUpdate(type, data) {
            let message, className;

            switch (type) {
                case 'new_post':
                    message = `📰 New post from ${data.source}: ${data.content_preview}`;
                    className = 'text-success';
                    break;
                case 'analysis_complete':
                    message = `🧠 Analysis: ${data.symbol} ${data.direction.toUpperCase()} (${Math.round(data.confidence * 100)}% confidence)`;
                    className = 'text-info';
                    break;
                case 'trade_executed':
                    message = `💰 Trade: ${data.direction.toUpperCase()} ${data.quantity} ${data.symbol} @ $${data.price}`;
                    className = 'text-warning';
                    break;
                case 'trade_closed':
                    const pnl = data.pnl > 0 ? `+$${data.pnl.toFixed(2)}` : `-$${Math.abs(data.pnl).toFixed(2)}`;
                    message = `🎯 Trade closed: ${data.symbol} P&L: ${pnl}`;
                    className = data.pnl > 0 ? 'text-success' : 'text-danger';
                    break;
                case 'scraper_error':
                    message = `⚠️ Scraping error from ${data.source}: ${data.error}`;
                    className = 'text-danger';
                    break;
                case 'trade_status':
                    message = `📊 ${data.status}`;
                    className = 'text-info';
                    break;
                case 'trade_close_requested':
                    const pnlText = data.pnl !== undefined ? ` P&L: ${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(2)}` : '';
                    message = `🚨 Close request: ${data.symbol} order submitted (ID: ${data.order_id})${pnlText}`;
                    className = 'text-warning';
                    break;
                default:
                    message = `🔄 Update: ${JSON.stringify(data)}`;
                    className = 'text-muted';
            }

            addLogEntry(message, className);

            // Auto-refresh dashboard data when important events occur
            if (['analysis_complete', 'trade_executed', 'trade_closed'].includes(type)) {
                setTimeout(refreshData, 1000);
            }
        }

        // Refresh data function
        function refreshData() {
            fetch('/api/system-status/')
                .then(response => response.json())
                .then(data => {
                    // Update API status
                    updateAPIStatus(data.api_status);

                    // Update metrics
                    document.getElementById('posts-count').textContent = data.statistics.posts_24h || 0;
                    document.getElementById('analyses-count').textContent = data.statistics.analyses_24h || 0;
                    document.getElementById('trades-count').textContent = data.statistics.trades_24h || 0;
                    document.getElementById('win-rate').textContent = (data.performance.win_rate || 0) + '%';

                    // Update status sections
                    document.getElementById('sources-active').textContent = data.statistics.active_sources || 0;
                    document.getElementById('last-scrape').textContent = 'Recently';
                    document.getElementById('next-scrape').textContent = 'Scheduled';

                    document.getElementById('pending-analysis').textContent = (data.statistics.total_posts - data.statistics.total_analyses) || 0;
                    document.getElementById('avg-confidence').textContent = (data.performance.avg_confidence || 0) + '%';
                    document.getElementById('last-analysis').textContent = 'Recently';

                    document.getElementById('open-positions').textContent = data.statistics.open_trades || 0;
                    // Display total P&L and day P&L from API; coerce to numbers safely
                    const totalPnlVal = Number(data.performance.total_pnl_24h || data.performance.total_pnl || 0);
                    const dayPnlVal = Number(data.performance.day_pnl || 0);
                    document.getElementById('total-pnl').textContent = '$' + totalPnlVal.toFixed(2);
                    document.getElementById('day-pnl').textContent = '$' + dayPnlVal.toFixed(2);
                    document.getElementById('account-value').textContent = '$' + (data.performance.account_value || 10000).toLocaleString();

                    // Update bot status
                    if (data.trading_config && data.trading_config.bot_enabled !== undefined) {
                        const botEnabled = data.trading_config.bot_enabled;
                        botToggle.checked = botEnabled;
                        originalBotState = botEnabled; // Store the current state
                        botStatusText.textContent = botEnabled ?
                            'Bot is currently active and monitoring markets' :
                            'Bot is currently disabled';
                        botToggleLabel.textContent = botEnabled ? 'ENABLED' : 'DISABLED';
                    }
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                    addLogEntry('Failed to refresh system data', 'text-danger');
                });
            
            // Also refresh activities from database
            refreshActivitiesFromDatabase();
        }

        // Function to refresh activities from database
        function refreshActivitiesFromDatabase() {
            fetch('/api/recent-activities/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.activities && data.activities.length > 0) {
                        // Clear existing log entries except the first one (Dashboard initialized)
                        while (logDiv.children.length > 1) {
                            logDiv.removeChild(logDiv.lastChild);
                        }
                        
                        // Add recent activities from database
                        data.activities.slice(0, 20).forEach(activity => {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry text-secondary';
                            logEntry.innerHTML = `
                                <i class="fas fa-database me-2" style="font-size: 6px;"></i>
                                <small class="text-muted">${activity.created_at}</small> ${activity.message}
                            `;
                            logDiv.appendChild(logEntry);
                        });
                        
                        // Add notice that these are from database
                        if (logDiv.children.length > 1) {
                            addLogEntry('📁 Showing recent activities from database', 'text-info');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching activities from database:', error);
                });
        }

        // Update API status badges
        function updateAPIStatus(apiStatus) {
            const statusMap = {
                'openai': { element: 'OpenAI', index: 0 },
                'news_sources': { element: 'News Sources', index: 1 },
                'alpaca': { element: 'Alpaca', index: 2 }
            };

            const badges = document.querySelectorAll('#api-status-row .status-badge');

            Object.keys(statusMap).forEach(api => {
                const statusInfo = apiStatus[api];
                const badge = badges[statusMap[api].index];
                if (badge && statusInfo) {
                    const statusText = statusInfo.status;
                    const isOk = statusText === 'ok';

                    // Update badge
                    badge.className = 'badge status-badge ' + (isOk ? 'bg-success' : statusText === 'warning' ? 'bg-warning text-dark' : 'bg-danger');
                    badge.textContent = isOk ? 'Connected' : (statusText === 'warning' ? 'Warning' : 'Error');

                    // Update card border based on status
                    const cardContainer = badge.closest('.col-md-4');
                    const card = cardContainer ? cardContainer.querySelector('.card') : null;
                    if (card) {
                        // Remove existing border classes
                        card.classList.remove('connected', 'disconnected', 'loading');
                        // Add new border class
                        if (isOk) {
                            card.classList.add('connected');
                        } else if (statusText === 'warning') {
                            card.classList.add('disconnected');
                        } else {
                            card.classList.add('disconnected');
                        }
                    }

                    // Update News Sources details
                    if (api === 'news_sources') {
                        const detailsElement = document.getElementById('news-sources-details');
                        if (detailsElement && statusInfo.count !== undefined) {
                            detailsElement.textContent = `${statusInfo.active_count}/${statusInfo.count} active`;
                        }
                    }
                }
            });
        }

        // Bot status toggle handler
        let pendingBotToggle = false;
        let originalBotState = false;

        function showBotToggleConfirmation(newState) {
            const isEnabling = newState;
            
            // Update modal content based on action
            const iconElement = document.getElementById('botToggleConfirmIcon');
            const alertElement = document.getElementById('botToggleConfirmAlert');
            const titleElement = document.getElementById('botToggleConfirmTitle');
            const messageElement = document.getElementById('botToggleConfirmMessage');
            const buttonElement = document.getElementById('botToggleConfirmButton');
            const buttonTextElement = document.getElementById('botToggleConfirmButtonText');
            
            if (isEnabling) {
                iconElement.className = 'fas fa-play-circle text-success';
                alertElement.className = 'alert alert-success';
                titleElement.textContent = 'Enable Trading Bot?';
                messageElement.textContent = 'This will activate all bot activities including automated scraping, analysis, and trading based on your configuration.';
                buttonElement.className = 'btn btn-success';
                buttonTextElement.textContent = 'Enable Bot';
            } else {
                iconElement.className = 'fas fa-stop-circle text-danger';
                alertElement.className = 'alert alert-danger';
                titleElement.textContent = 'Disable Trading Bot?';
                messageElement.textContent = 'This will stop all bot activities including scraping, analysis, and trading. Existing open positions will remain active but no new trades will be executed.';
                buttonElement.className = 'btn btn-danger';
                buttonTextElement.textContent = 'Disable Bot';
            }
            
            // Store the pending state
            pendingBotToggle = newState;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('botToggleConfirmModal'));
            modal.show();
        }

        function confirmBotToggle() {
            // Close the modal first
            const modal = bootstrap.Modal.getInstance(document.getElementById('botToggleConfirmModal'));
            modal.hide();
            
            // Execute the actual toggle
            updateBotStatus();
        }

        function updateBotStatus() {
            fetch('/api/toggle-bot-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const statusText = data.bot_enabled ? 'enabled' : 'disabled';
                        addLogEntry(`Bot ${statusText} successfully`, 'text-success');
                        
                        // Update the UI to reflect the actual state
                        botToggle.checked = data.bot_enabled;
                        botStatusText.textContent = data.bot_enabled ?
                            'Bot is currently active and monitoring markets' :
                            'Bot is currently disabled';
                        botToggleLabel.textContent = data.bot_enabled ? 'ENABLED' : 'DISABLED';
                        
                        // Update stored state
                        originalBotState = data.bot_enabled;
                    } else {
                        addLogEntry(`Failed to update bot status: ${data.error}`, 'text-danger');
                        // Reset toggle to original state on error
                        botToggle.checked = originalBotState;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLogEntry('Failed to update bot status', 'text-danger');
                    // Reset toggle to original state on error
                    botToggle.checked = originalBotState;
                });
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Quick Tools Functions
        function exportSystemData() {
            if (confirm('Export system data to CSV? This may take a moment.')) {
                alert('Data export functionality coming soon!');
            }
        }

        function viewSystemLogs() {
            window.open('/admin/core/', '_blank');
        }

        function clearSystemCache() {
            if (confirm('Clear system cache? This will refresh all cached data.')) {
                alert('Cache clearing functionality coming soon!');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            addLogEntry('🚀 Dashboard initialized with live polling', 'text-success');
            
            // Start polling for updates every 3 seconds
            pollForUpdates(); // Load initial activities
            setInterval(pollForUpdates, 3000);

            // Initial data refresh
            refreshData();

            // Set up auto-refresh
            setInterval(refreshData, 30000);

            // Bot toggle event listener
            if (botToggle) {
                botToggle.addEventListener('change', function (event) {
                    // Prevent the default change behavior
                    event.preventDefault();
                    
                    // Get the intended new state
                    const newState = this.checked;
                    
                    // Reset the toggle to its previous state immediately
                    // (it will be updated properly after confirmation)
                    this.checked = originalBotState;
                    
                    // Show confirmation modal
                    showBotToggleConfirmation(newState);
                });
            }

            // Bot toggle confirmation modal event listeners
            const botToggleModal = document.getElementById('botToggleConfirmModal');
            if (botToggleModal) {
                // Reset toggle when modal is hidden without confirmation
                botToggleModal.addEventListener('hidden.bs.modal', function () {
                    // Ensure the toggle is in the correct state
                    if (botToggle) {
                        botToggle.checked = originalBotState;
                    }
                });
            }

            addLogEntry('Dashboard fully loaded and ready', 'text-success');
        });

        // Connection check functions
        let currentService = null;

        function checkConnection(service) {
            currentService = service;
            const modal = new bootstrap.Modal(document.getElementById('connectionCheckModal'));

            // Reset modal content
            document.getElementById('connectionCheckResult').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Checking connection...</span>
                    </div>
                    <p class="mt-2">Checking ${service.toUpperCase()} connection...</p>
                </div>
            `;

            // Update modal title
            document.getElementById('connectionCheckModalLabel').innerHTML = `
                <i class="fas fa-link me-2"></i>${service.toUpperCase()} Connection Check
            `;

            modal.show();

            // Make API call to check specific service
            fetch(`/api/check-connection/${service}`)
                .then(response => response.json())
                .then(data => {
                    displayConnectionResult(data, service);
                })
                .catch(error => {
                    displayConnectionResult({
                        status: 'error',
                        message: 'Failed to check connection: ' + error.message
                    }, service);
                });
        }

        function recheckConnection() {
            if (currentService) {
                checkConnection(currentService);
            }
        }

        function displayConnectionResult(data, service) {
            const resultDiv = document.getElementById('connectionCheckResult');

            let statusIcon, statusClass, statusText;

            switch (data.status) {
                case 'ok':
                    statusIcon = 'fas fa-check-circle';
                    statusClass = 'text-success';
                    statusText = 'Connected';
                    break;
                case 'warning':
                    statusIcon = 'fas fa-exclamation-triangle';
                    statusClass = 'text-warning';
                    statusText = 'Warning';
                    break;
                case 'error':
                    statusIcon = 'fas fa-times-circle';
                    statusClass = 'text-danger';
                    statusText = 'Error';
                    break;
                default:
                    statusIcon = 'fas fa-question-circle';
                    statusClass = 'text-secondary';
                    statusText = 'Unknown';
            }

            let resultHtml = `
                <div class="text-center mb-3">
                    <i class="${statusIcon} ${statusClass}" style="font-size: 3rem;"></i>
                    <h4 class="mt-2 ${statusClass}">${statusText}</h4>
                </div>
                <div class="alert alert-${data.status === 'ok' ? 'success' : data.status === 'warning' ? 'warning' : 'danger'}">
                    <strong>Status:</strong> ${data.message}
                </div>
            `;

            // Add additional details if available
            if (data.account_status) {
                resultHtml += `
                    <div class="row">
                        <div class="col-6">
                            <strong>Account Status:</strong><br>
                            <span class="badge bg-info">${data.account_status}</span>
                        </div>
                `;
                if (data.buying_power) {
                    resultHtml += `
                        <div class="col-6">
                            <strong>Buying Power:</strong><br>
                            <span class="text-success">$${data.buying_power}</span>
                        </div>
                    `;
                }
                resultHtml += `</div>`;
            }

            if (data.count !== undefined) {
                resultHtml += `
                    <div class="mt-2">
                        <strong>Sources:</strong> ${data.active_count}/${data.count} active
                    </div>
                `;
            }

            resultDiv.innerHTML = resultHtml;
        }
    </script>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}